name: Deploy Streamlit to EC2

on:
  push:
    branches:
      - main  # main 브랜치에 push될 때 트리거

jobs:
  deploy:
    runs-on: ubuntu-latest

	steps:
      - name: SSH Remote Commands
        uses: appleboy/ssh-action@v1.0.3
        env:
          # 1. GitHub Secret을 워크플로우 환경변수로 가져옵니다.
          ENV_CONTENTS: ${{ secrets.ENV_FILE }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          port: 22
          # 2. 스크립트 내부에서 사용할 환경변수 이름을 등록합니다.
          envs: ENV_CONTENTS
          script: |
            REPO_URL="https://github.com/Ohgiraffers-bear/KU_RAG_CHATBOT.git"
            DIR_NAME="KU_RAG_CHATBOT"
            FILE_NAME="app.py"
            PORT="8501"

            # 폴더 없으면 Clone, 있으면 Pull
            if [ -d "$DIR_NAME" ]; then
              cd $DIR_NAME
              git pull origin main
            else
              git clone $REPO_URL
              cd $DIR_NAME
            fi

            # --- [핵심 변경 사항] .env 파일 생성 ---
            # Secret에 저장된 내용을 .env 파일로 덮어씁니다.
            echo "$ENV_CONTENTS" > .env
            echo ".env file created successfully."
            # ------------------------------------

            if [ -f "requirements.txt" ]; then
              pip install -r requirements.txt
            fi

            PID=$(lsof -t -i:$PORT)
            if [ -n "$PID" ]; then
              kill -9 $PID
            fi

            nohup streamlit run $FILE_NAME --server.port $PORT --server.runOnSave true > nohup.out 2>&1 &
